(()=>{"use strict";const e=window.crypto||window.msCrypto,t=window.localStorage,n="hexo-blog-encrypt:#"+window.location.pathname,r=h("hexo-blog-encrypt的作者们都是大帅比!"),o=h("hexo-blog-encrypt是地表最强Hexo加密插件!"),a=document.getElementById("hexo-blog-encrypt"),i=a.dataset.wpm,c=a.dataset.whm;var l=a.getElementsByTagName("script").hbeData;const s=l.innerText,d=l.dataset.hmacdigest;function y(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map((e=>parseInt(e,16))))}function h(e){for(var t=e.length,n=0,r=new Array,o=0;o<t;){var a=e.codePointAt(o);a<128?(r[n++]=a,o++):127<a&&a<2048?(r[n++]=a>>6|192,r[n++]=63&a|128,o++):2047<a&&a<65536?(r[n++]=a>>12|224,r[n++]=a>>6&63|128,r[n++]=63&a|128,o++):(r[n++]=a>>18|240,r[n++]=a>>12&63|128,r[n++]=a>>6&63|128,r[n++]=63&a|128,o+=2)}return new Uint8Array(r)}async function u(t,r,o){var a=y(s);return await e.subtle.decrypt({name:"AES-CBC",iv:r},t,a.buffer).then((async t=>{if(!(t=(new TextDecoder).decode(t)).startsWith("<hbe-prefix></hbe-prefix>"))throw"Decode successfully but not start with KnownPrefix.";var r=((r=document.createElement("button")).textContent="Encrypt again",r.type="button",r.classList.add("hbe-button"),r.addEventListener("click",(()=>{window.localStorage.removeItem(n),window.location.reload()})),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await async function(e){var t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach((async e=>{e.replaceWith(await async function(e){let t=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach((n=>{e[n]&&(t[n]=e[n])})),t}(e))})),t}(t)),document.getElementById("hexo-blog-encrypt").appendChild(r),document.querySelectorAll("img").forEach((e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))})),window.NexT&&NexT.boot&&"function"==typeof NexT.boot.refresh&&NexT.boot.refresh(),document.getElementById("toc-div")),a=(r&&(r.style.display="inline"),document.getElementsByClassName("toc-div-class"));if(a&&0<a.length)for(var i=0;i<a.length;i++)a[i].style.display="inline";var l;r=new Event("hexo-blog-decrypt");return window.dispatchEvent(r),r=o,t=(new TextEncoder).encode(t),l=y(d),r=await e.subtle.verify({name:"HMAC",hash:"SHA-256"},r,l,t),console.log("Verification result: "+r),r||(alert(c),console.log(c+", got ",l," but proved wrong.")),r})).catch((e=>(alert(i),console.log(e),!1)))}if(l=JSON.parse(t.getItem(n))){console.log(`Password got from localStorage(${n}): `,l);const r=y(l.iv).buffer;var m=l.dk;const o=l.hmk;e.subtle.importKey("jwk",m,{name:"AES-CBC",length:256},!0,["decrypt"]).then((a=>{e.subtle.importKey("jwk",o,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then((e=>{u(a,r,e).then((e=>{e||t.removeItem(n)}))}))}))}a.addEventListener("keydown",(async a=>{if(a.isComposing||"Enter"===a.key){a=document.getElementById("hbePass").value,i=new TextEncoder,a=i=await e.subtle.importKey("raw",i.encode(a),{name:"PBKDF2"},!1,["deriveKey","deriveBits"]);const c=await e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:r.buffer,iterations:1024},a,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]),l=(a=i,await e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:r.buffer,iterations:1024},a,{name:"AES-CBC",length:256},!0,["decrypt"])),s=(a=i,await e.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:o.buffer,iterations:512},a,128));u(l,s,c).then((r=>{console.log("Decrypt result: "+r),r&&e.subtle.exportKey("jwk",l).then((r=>{e.subtle.exportKey("jwk",c).then((e=>{e={dk:r,iv:function(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r}(s),hmk:e},t.setItem(n,JSON.stringify(e))}))}))}))}var i}))})();